using System;
using System.Collections.Generic;
using System.IO;

namespace DwarfFrontierComplete
{
    class Program
    {
        // --- DÜNYA VE STATLAR ---
        static int worldSize = 500;
        static char[,] worldMap = new char[worldSize, worldSize];
        static int screenW = 60, screenH = 20;

        static int px = 250, py = 250;
        static double health = 100, maxHealth = 100, hunger = 100;
        static int stone = 50, wood = 50, coal = 0, iron = 0, diamond = 0, arrows = 5;
        static int level = 1, xp = 0;

        // --- ENVANTER VE EKİPMAN ---
        static bool hasBow = false;
        static bool hasShield = false;
        static int armorLevel = 0;

        static int worldTime = 800;
        static bool buildMode = false;
        static int bx, by;
        static List<Entity> entities = new List<Entity>();
        static string status = "E: Envanter | C: Craft | B: İnşa | Q: Kaydet";

        static void Main(string[] args)
        {
            Console.OutputEncoding = System.Text.Encoding.UTF8;
            Console.CursorVisible = false;
            LoadGame();

            while (health > 0)
            {
                UpdateTime();
                Draw();
                HandleInput();
                UpdateLogic();
            }
            Console.Clear();
            Console.WriteLine("CÜCE DESTANI SONA ERDİ. SEVİYE: " + level);
            Console.ReadLine();
        }

        static void GenerateWorld()
        {
            Random rng = new Random();
            for (int y = 0; y < worldSize; y++)
                for (int x = 0; x < worldSize; x++)
                {
                    int r = rng.Next(1000);
                    if (r < 25) worldMap[x, y] = 'T';      
                    else if (r < 40) worldMap[x, y] = 'O'; 
                    else if (r < 55) worldMap[x, y] = 'K'; 
                    else if (r < 65) worldMap[x, y] = 'I'; 
                    else if (r < 68) worldMap[x, y] = 'S'; 
                    else if (r < 110) worldMap[x, y] = '#';
                    else if (r < 112) worldMap[x, y] = '>';
                    else worldMap[x, y] = '.';
                }
            GenerateVillage(260, 260);
            entities.Add(new Entity { x = 245, y = 245, type = 'E', hp = 50 });
        }

        static void GenerateVillage(int vx, int vy)
        {
            entities.Add(new Entity { x = vx + 1, y = vy + 1, type = 'D', hp = 100 }); 
            entities.Add(new Entity { x = vx + 3, y = vy + 3, type = 'G', hp = 500 }); 
            for (int i = -2; i < 5; i++) for (int j = -2; j < 5; j++) worldMap[vx + i, vy + j] = '_';
        }

        static void UpdateTime()
        {
            worldTime += 2; if (worldTime >= 2400) worldTime = 0;
            hunger -= 0.02; if (hunger < 0) { hunger = 0; health -= 0.1; }
        }

        static void Draw()
        {
            Console.SetCursorPosition(0, 0);
            bool isNight = (worldTime > 1800 || worldTime < 600);
            int viewRange = isNight ? 8 : 35;

            int startX = Math.Clamp(px - screenW / 2, 0, worldSize - screenW);
            int startY = Math.Clamp(py - screenH / 2, 0, worldSize - screenH);

            for (int y = startY; y < startY + screenH; y++)
            {
                for (int x = startX; x < startX + screenW; x++)
                {
                    double dist = Math.Sqrt(Math.Pow(x - px, 2) + Math.Pow(y - py, 2));
                    if (dist > viewRange && worldMap[x, y] != 'i') { Console.Write(' '); continue; }

                    Entity ent = entities.Find(e => e.x == x && e.y == y);
                    if (x == px && y == py) { Console.ForegroundColor = ConsoleColor.Cyan; Console.Write('@'); }
                    else if (buildMode && x == bx && y == by) { Console.ForegroundColor = ConsoleColor.Magenta; Console.Write('X'); }
                    else if (ent != null)
                    {
                        Console.ForegroundColor = ent.type == 'G' ? ConsoleColor.White : (ent.type == 'D' ? ConsoleColor.Yellow : ConsoleColor.Red);
                        Console.Write(ent.type);
                    }
                    else { SetColor(worldMap[x, y]); Console.Write(worldMap[x, y]); }
                }
                Console.WriteLine();
            }
            Console.ResetColor();
            Console.WriteLine($"LVL:{level} | CAN:%{(int)health} | AÇLIK:%{(int)hunger} | SAAT:{worldTime / 100:D2}:00");
            Console.WriteLine($"{status.PadRight(screenW)}");
        }

        static void SetColor(char c)
        {
            switch (c)
            {
                case 'T': Console.ForegroundColor = ConsoleColor.Green; break;
                case 'I': Console.ForegroundColor = ConsoleColor.Blue; break;
                case 'S': Console.ForegroundColor = ConsoleColor.Cyan; break;
                case 'K': Console.ForegroundColor = ConsoleColor.DarkGray; break;
                case ',': Console.ForegroundColor = ConsoleColor.DarkGreen; break;
                case 'i': Console.ForegroundColor = ConsoleColor.Yellow; break;
                case '#': Console.ForegroundColor = ConsoleColor.Gray; break;
                case '=': Console.ForegroundColor = ConsoleColor.DarkYellow; break;
                case '/': Console.ForegroundColor = ConsoleColor.Red; break;
                case '>': Console.ForegroundColor = ConsoleColor.Magenta; break;
                default: Console.ForegroundColor = ConsoleColor.DarkGray; break;
            }
        }

        static void HandleInput()
        {
            if (!Console.KeyAvailable) return;
            var key = Console.ReadKey(true).Key;

            if (key == ConsoleKey.Q) { SaveGame(); Environment.Exit(0); }
            if (key == ConsoleKey.E) { ShowInventory(); return; } // ENVANTER AÇILIŞI
            if (key == ConsoleKey.B) { buildMode = !buildMode; bx = px; by = py; return; }
            if (key == ConsoleKey.C) { CraftMenu(); return; }
            if (key == ConsoleKey.T) { Trade(); return; }

            if (buildMode)
            {
                if (key == ConsoleKey.UpArrow) by--; if (key == ConsoleKey.DownArrow) by++;
                if (key == ConsoleKey.LeftArrow) bx--; if (key == ConsoleKey.RightArrow) bx++;
                if (key == ConsoleKey.D1 && stone >= 5) { worldMap[bx, by] = '#'; stone -= 5; }
                if (key == ConsoleKey.D2 && wood >= 5) { worldMap[bx, by] = '='; wood -= 5; }
                if (key == ConsoleKey.D3 && wood >= 10) { worldMap[bx, by] = '/'; wood -= 10; }
                if (key == ConsoleKey.D4 && coal >= 1) { worldMap[bx, by] = 'i'; coal -= 1; }
                if (key == ConsoleKey.D5 && wood >= 2) { worldMap[bx, by] = ','; wood -= 2; }
            }
            else
            {
                int nx = px, ny = py;
                if (key == ConsoleKey.UpArrow) ny--; else if (key == ConsoleKey.DownArrow) ny++;
                else if (key == ConsoleKey.LeftArrow) nx--; else if (key == ConsoleKey.RightArrow) nx++;
                else if (key == ConsoleKey.Spacebar) Attack(true);
                else if (key == ConsoleKey.F) Attack(false);

                if (nx >= 0 && nx < worldSize && ny >= 0 && ny < worldSize)
                {
                    char t = worldMap[nx, ny];
                    if (t == 'T' || t == 'O' || t == 'K' || t == 'I' || t == 'S' || t == '#')
                    {
                        if (t == 'T') wood += 5; else if (t == 'I') iron += 3;
                        else if (t == 'S') diamond += 1; else if (t == 'K') coal += 5;
                        else stone += 2;
                        worldMap[nx, ny] = '.'; xp += 10; CheckLvl();
                    }
                    else if (t == '>') { px = 100; py = 100; status = "Zindana Girdin!"; }
                    else { px = nx; py = ny; }
                }
            }
        }

        static void ShowInventory()
        {
            Console.Clear();
            Console.ForegroundColor = ConsoleColor.Cyan;
            Console.WriteLine("======================================");
            Console.WriteLine("          CÜCE ENVANTERİ              ");
            Console.WriteLine("======================================");
            Console.ResetColor();
            Console.WriteLine($" [KAYNAKLAR] ");
            Console.WriteLine($" Taş:    {stone}    Odun:   {wood}");
            Console.WriteLine($" Kömür:  {coal}     Demir:  {iron}");
            Console.WriteLine($" Elmas:  {diamond} ");
            Console.WriteLine("--------------------------------------");
            Console.WriteLine($" [EKİPMANLAR] ");
            Console.WriteLine($" Yay:     {(hasBow ? "VAR" : "YOK")}");
            Console.WriteLine($" Ok:      {arrows} adet");
            Console.WriteLine($" Kalkan:  {(hasShield ? "VAR" : "YOK")}");
            Console.WriteLine($" Zırh Seviyesi: {armorLevel}");
            Console.WriteLine("--------------------------------------");
            Console.WriteLine($" Seviye: {level} (XP: {xp})");
            Console.WriteLine("======================================");
            Console.WriteLine(" Devam etmek için herhangi bir tuşa bas...");
            Console.ReadKey();
        }

        static void CraftMenu()
        {
            Console.Clear();
            Console.WriteLine("=== ZANAAT (CRAFT) MENÜSÜ ===");
            Console.WriteLine($"1. Yay Üret (30 Odun) - {(hasBow ? "[SAHİPSİN]" : "")}");
            Console.WriteLine($"2. Ok Üret x10 (5 Taş, 2 Odun)");
            Console.WriteLine($"3. Demir Kalkan (30 Demir) - {(hasShield ? "[SAHİPSİN]" : "")}");
            Console.WriteLine($"4. Demir Zırh (50 Demir) - Seviye: {armorLevel}");
            Console.WriteLine("ESC. Vazgeç");
            
            var k = Console.ReadKey(true).Key;
            if (k == ConsoleKey.D1 && wood >= 30) { hasBow = true; wood -= 30; }
            if (k == ConsoleKey.D2 && stone >= 5 && wood >= 2) { arrows += 10; stone -= 5; wood -= 2; }
            if (k == ConsoleKey.D3 && iron >= 30) { hasShield = true; iron -= 30; }
            if (k == ConsoleKey.D4 && iron >= 50) { armorLevel++; iron -= 50; maxHealth += 25; health = maxHealth; }
        }

        static void Trade()
        {
            Entity trd = entities.Find(e => e.type == 'D' && Math.Abs(e.x - px) <= 1 && Math.Abs(e.y - py) <= 1);
            if (trd == null) return;
            Console.Clear();
            Console.WriteLine("=== TÜCCAR ===");
            Console.WriteLine("1. 1 Elmas -> 200 Taş");
            Console.WriteLine("2. 50 Taş -> 20 Demir");
            var k = Console.ReadKey(true).Key;
            if (k == ConsoleKey.D1 && diamond >= 1) { diamond--; stone += 200; }
            if (k == ConsoleKey.D2 && stone >= 50) { stone -= 50; iron += 20; }
        }

        static void Attack(bool close)
        {
            Entity target = entities.Find(e => e.type == 'E' && Math.Abs(e.x - px) <= (close ? 1 : 10) && Math.Abs(e.y - py) <= (close ? 1 : 10));
            if (target != null)
            {
                if (!close && (!hasBow || arrows <= 0)) { status = "Yay yok veya ok bitti!"; return; }
                if (!close) arrows--;
                target.hp -= (20 + level * 5);
                if (target.hp <= 0) { entities.Remove(target); xp += 50; CheckLvl(); }
            }
        }

        static void UpdateLogic()
        {
            if (worldMap[px, py] == ',') { hunger = Math.Min(100, hunger + 0.1); health = Math.Min(maxHealth, health + 0.1); }
            foreach (var ent in entities)
            {
                if (ent.type == 'E')
                {
                    if (ent.x < px) ent.x++; else ent.x--;
                    if (ent.y < py) ent.y++; else ent.y--;
                    if (ent.x == px && ent.y == py) health -= (5 - (hasShield ? 2 : 0));
                }
            }
        }

        static void CheckLvl() { if (xp >= level * 100) { level++; xp = 0; maxHealth += 20; health = maxHealth; status = "SEVİYE ATLADIN!"; } }

        static void SaveGame() { File.WriteAllText("dwarf_save.txt", $"{px},{py},{health},{stone},{wood},{iron},{diamond},{level},{xp},{hunger},{hasBow},{hasShield},{armorLevel}"); }

        static void LoadGame()
        {
            if (File.Exists("dwarf_save.txt"))
            {
                string[] s = File.ReadAllText("dwarf_save.txt").Split(',');
                px = int.Parse(s[0]); py = int.Parse(s[1]); health = double.Parse(s[2]);
                stone = int.Parse(s[3]); wood = int.Parse(s[4]); iron = int.Parse(s[5]);
                diamond = int.Parse(s[6]); level = int.Parse(s[7]); xp = int.Parse(s[8]);
                hunger = double.Parse(s[9]); hasBow = bool.Parse(s[10]);
                hasShield = bool.Parse(s[11]); armorLevel = int.Parse(s[12]);
            }
            GenerateWorld();
        }
    }
    class Entity { public int x, y, hp; public char type; }
}